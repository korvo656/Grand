<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="mobile-web-app-capable" content="yes">
    <title>VR Building Viewer</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            user-select: none;
        }
        
        html, body {
            background: #000;
            overflow: hidden;
            width: 100%;
            height: 100%;
            font-family: Arial, sans-serif;
            position: fixed;
            touch-action: none;
            -webkit-text-size-adjust: none;
            text-size-adjust: none;
            overscroll-behavior: none;
        }
        
        #renderCanvas {
            width: 100%;
            height: 100%;
            display: block;
            outline: none;
            touch-action: none;
        }
        
        .loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            font-size: 18px;
            z-index: 1000;
            text-align: center;
            background: rgba(0,0,0,0.7);
            padding: 20px;
            border-radius: 10px;
        }
        
        .hidden {
            display: none !important;
        }
        
        .view-indicator {
            position: absolute;
            top: 20px;
            right: 20px;
            color: #fff;
            background: rgba(0,0,0,0.7);
            padding: 10px 15px;
            border-radius: 20px;
            font-size: 14px;
            z-index: 100;
            transition: opacity 0.5s;
        }
        
        .mode-indicator {
            position: absolute;
            top: 20px;
            left: 20px;
            color: #fff;
            background: rgba(0,0,0,0.7);
            padding: 10px 15px;
            border-radius: 20px;
            font-size: 14px;
            z-index: 100;
            transition: opacity 0.5s;
        }
        
        .side-indicator {
            position: absolute;
            bottom: 20px;
            left: 0;
            right: 0;
            color: white;
            text-align: center;
            background: rgba(0,0,0,0.5);
            padding: 10px;
            font-size: 16px;
            z-index: 100;
            transition: opacity 0.5s;
        }
        
        .gesture-indicator {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 80px;
            height: 80px;
            background: rgba(255,255,255,0.1);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 32px;
            z-index: 100;
            opacity: 0;
            transition: opacity 0.3s;
        }
        
        .gesture-indicator.active {
            opacity: 1;
        }
        
        @keyframes tapPulse {
            0% { transform: translate(-50%, -50%) scale(1); }
            50% { transform: translate(-50%, -50%) scale(1.2); }
            100% { transform: translate(-50%, -50%) scale(1); }
        }
        
        .tap-animation {
            animation: tapPulse 0.5s ease-in-out;
        }
        
        .fullscreen-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #000;
            z-index: 9999;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            color: white;
            text-align: center;
            padding: 20px;
        }
        
        .fullscreen-btn {
            background: rgba(255,255,255,0.2);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 10px;
            font-size: 18px;
            margin-top: 20px;
            cursor: pointer;
        }
        
        .error-message {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: #ff6b6b;
            font-size: 16px;
            text-align: center;
            background: rgba(0,0,0,0.8);
            padding: 20px;
            border-radius: 10px;
            z-index: 1000;
            max-width: 80%;
        }
        
        .gyro-status {
            position: absolute;
            top: 60px;
            left: 20px;
            color: #fff;
            background: rgba(0,0,0,0.7);
            padding: 10px 15px;
            border-radius: 20px;
            font-size: 14px;
            z-index: 100;
            transition: opacity 0.5s;
        }
        
        .fade-out {
            opacity: 0;
        }
        
        .mode-toggle-btn {
            position: absolute;
            bottom: 20px;
            right: 20px;
            width: 60px;
            height: 60px;
            background: rgba(255,255,255,0.2);
            border: none;
            border-radius: 50%;
            color: white;
            font-size: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 100;
            cursor: pointer;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
        }
        
        .mode-toggle-btn:hover {
            background: rgba(255,255,255,0.3);
        }
        
        .mode-toggle-btn:active {
            transform: scale(0.95);
        }

        .gallery-toggle-btn {
            position: absolute;
            bottom: 90px;
            right: 20px;
            width: 60px;
            height: 60px;
            background: rgba(255,255,255,0.2);
            border: none;
            border-radius: 50%;
            color: white;
            font-size: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 100;
            cursor: pointer;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
        }
        
        .gallery-toggle-btn:hover {
            background: rgba(255,255,255,0.3);
        }
        
        .gallery-toggle-btn:active {
            transform: scale(0.95);
        }

        .music-toggle-btn {
            position: absolute;
            bottom: 160px;
            right: 20px;
            width: 60px;
            height: 60px;
            background: rgba(255,255,255,0.2);
            border: none;
            border-radius: 50%;
            color: white;
            font-size: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 100;
            cursor: pointer;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
        }
        
        .music-toggle-btn:hover {
            background: rgba(255,255,255,0.3);
        }
        
        .music-toggle-btn:active {
            transform: scale(0.95);
        }

        .music-toggle-btn.muted {
            opacity: 0.5;
        }

        .vr-divider {
            position: absolute;
            top: 0;
            left: 50%;
            width: 2px;
            height: 100%;
            background: rgba(255,255,255,0.1);
            z-index: 50;
            pointer-events: none;
        }

        .gallery-container {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #000;
            z-index: 200;
            display: flex;
            flex-direction: column;
        }
        
        .image-container {
            position: relative;
            flex: 1;
            display: flex;
            justify-content: center;
            align-items: center;
            width: 100%;
            overflow: hidden;
        }
        
        .gallery-image {
            transition: opacity 0.3s ease;
            width: 100%;
            height: 100%;
            object-fit: contain;
        }
        
        .gallery-controls {
            flex-shrink: 0;
            display: flex;
            justify-content: center;
            gap: 20px;
            padding: 20px;
            background: rgba(0,0,0,0.7);
        }
        
        .gallery-btn {
            background: rgba(255,255,255,0.2);
            color: white;
            border: none;
            padding: 15px 25px;
            border-radius: 10px;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
        }
        
        .gallery-btn:hover {
            background: rgba(255,255,255,0.3);
        }
        
        .gallery-btn:active {
            transform: scale(0.95);
        }
        
        .photo-counter {
            position: absolute;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            color: white;
            background: rgba(0,0,0,0.7);
            padding: 10px 15px;
            border-radius: 20px;
            font-size: 14px;
            z-index: 210;
        }

        .volume-control {
            position: absolute;
            bottom: 230px;
            right: 20px;
            width: 60px;
            height: 120px;
            background: rgba(0,0,0,0.7);
            border-radius: 30px;
            padding: 10px 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: space-between;
            z-index: 100;
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
        }

        .volume-slider {
            width: 5px;
            height: 80px;
            background: rgba(255,255,255,0.2);
            border-radius: 5px;
            position: relative;
            cursor: pointer;
        }

        .volume-level {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            background: #4CAF50;
            border-radius: 5px;
            transition: height 0.2s;
        }

        .volume-up, .volume-down {
            background: none;
            border: none;
            color: white;
            font-size: 16px;
            cursor: pointer;
            padding: 5px;
        }
        
        .gallery-loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            z-index: 1;
        }
        
        /* –°—Ç–∏–ª–∏ –¥–ª—è –Ω–∞–∑–≤–∞–Ω–∏—è –ª–µ—á–µ–±–Ω–∏—Ü—ã */
        .clinic-title {
            position: absolute;
            top: 10px;
            left: 0;
            right: 0;
            text-align: center;
            color: white;
            font-size: 18px;
            font-weight: bold;
            z-index: 100;
            background: rgba(0,0,0,0.7);
            padding: 10px 20px;
            margin: 0 auto;
            width: fit-content;
            border-radius: 0 0 10px 10px;
            transition: opacity 0.5s;
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
        }
        
        /* –ê–¥–∞–ø—Ç–∏–≤–Ω—ã–µ —Å—Ç–∏–ª–∏ –¥–ª—è –Ω–∞–∑–≤–∞–Ω–∏—è */
        @media (max-width: 768px) {
            .clinic-title {
                font-size: 16px;
                padding: 8px 15px;
            }
        }
        
        @media (max-width: 480px) {
            .clinic-title {
                font-size: 14px;
                padding: 6px 12px;
            }
        }
        
        @media (max-height: 500px) {
            .clinic-title {
                font-size: 12px;
                padding: 4px 10px;
            }
        }
        
        /* –°—Ç–∏–ª–∏ –¥–ª—è –∞–¥–∞–ø—Ç–∞—Ü–∏–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –ø–æ–¥ —ç–∫—Ä–∞–Ω */
        @media (orientation: portrait) {
            .gallery-image {
                object-fit: contain;
            }
        }
        
        @media (orientation: landscape) {
            .gallery-image {
                object-fit: contain;
            }
        }
        
        /* –î–ª—è –æ—á–µ–Ω—å –º–∞–ª–µ–Ω—å–∫–∏—Ö —ç–∫—Ä–∞–Ω–æ–≤ */
        @media (max-height: 500px) {
            .gallery-controls {
                padding: 10px;
            }
            
            .gallery-btn {
                padding: 10px 15px;
                font-size: 14px;
            }
            
            .photo-counter {
                top: 10px;
                font-size: 12px;
                padding: 8px 12px;
            }
        }
        
        /* –î–ª—è –æ—á–µ–Ω—å —à–∏—Ä–æ–∫–∏—Ö —ç–∫—Ä–∞–Ω–æ–≤ */
        @media (min-aspect-ratio: 2/1) {
            .gallery-image {
                object-fit: cover;
            }
        }
    </style>
</head>
<body>
    <div id="fullscreenOverlay" class="fullscreen-overlay">
        <h2>VR Building Viewer</h2>
        <p>–î–ª—è –Ω–∞–∏–ª—É—á—à–µ–≥–æ –æ–ø—ã—Ç–∞ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –ø–æ–ª–Ω–æ—ç–∫—Ä–∞–Ω–Ω—ã–π —Ä–µ–∂–∏–º</p>
        <button id="enterFullscreen" class="fullscreen-btn">–û—Ç–∫—Ä—ã—Ç—å –≤ –ø–æ–ª–Ω–æ—ç–∫—Ä–∞–Ω–Ω–æ–º —Ä–µ–∂–∏–º–µ</button>
        <p style="margin-top: 20px; font-size: 14px; opacity: 0.7;">–ò–ª–∏ –Ω–∞–∂–º–∏—Ç–µ –Ω–∞ —ç–∫—Ä–∞–Ω –¥–ª—è –ø—Ä–æ–¥–æ–ª–∂–µ–Ω–∏—è</p>
    </div>
    
    <div id="loading" class="loading hidden">
        –ó–∞–≥—Ä—É–∑–∫–∞ –º–æ–¥–µ–ª–∏...<br>
        <small>–†–∞–∑—Ä–µ—à–∏—Ç–µ –¥–æ—Å—Ç—É–ø –∫ –≥–∏—Ä–æ—Å–∫–æ–ø—É –ø—Ä–∏ –∑–∞–ø—Ä–æ—Å–µ</small>
    </div>
    
    <!-- –î–æ–±–∞–≤–ª–µ–Ω –∑–∞–≥–æ–ª–æ–≤–æ–∫ –ª–µ—á–µ–±–Ω–∏—Ü—ã -->
    <div id="clinicTitle" class="clinic-title hidden">–¢–æ—Ä–≥–æ–≤—ã–π –¥–æ–º –ë–∞–¥–º–∞–µ–≤–∞</div>
    
    <div id="viewIndicator" class="view-indicator hidden">–í–∏–¥: –§–∞—Å–∞–¥</div>
    <div id="modeIndicator" class="mode-indicator hidden">–†–µ–∂–∏–º: –û–±—ã—á–Ω—ã–π</div>
    <div id="gyroStatus" class="gyro-status hidden">–ì–∏—Ä–æ—Å–∫–æ–ø: –ù–µ –∞–∫—Ç–∏–≤–µ–Ω</div>
    
    <div id="sideIndicator" class="side-indicator hidden">
        –ù–∞–∂–º–∏—Ç–µ –Ω–∞ —ç–∫—Ä–∞–Ω –¥–ª—è —Å–º–µ–Ω—ã —Å—Ç–æ—Ä–æ–Ω—ã
    </div>
    
    <div class="gesture-indicator hidden" id="gestureIndicator">üëÜ</div>
    
    <button id="modeToggleBtn" class="mode-toggle-btn hidden">üîÑ</button>
    <button id="galleryToggleBtn" class="gallery-toggle-btn hidden">üñºÔ∏è</button>
    <button id="musicToggleBtn" class="music-toggle-btn hidden">üîä</button>
    
    <div id="volumeControl" class="volume-control hidden">
        <button class="volume-up">+</button>
        <div class="volume-slider">
            <div class="volume-level" id="volumeLevel" style="height: 70%;"></div>
        </div>
        <button class="volume-down">-</button>
    </div>
    
    <div id="errorMessage" class="error-message hidden"></div>
    
    <div id="vrDivider" class="vr-divider hidden"></div>
    
    <canvas id="renderCanvas" class="hidden"></canvas>

    <div id="galleryContainer" class="gallery-container hidden">
        <div class="photo-counter" id="photoCounter">–§–æ—Ç–æ 1/10</div>
        <div class="image-container">
            <img id="galleryImage" class="gallery-image" src="" alt="–§–æ—Ç–æ –ø—Ä–æ–µ–∫—Ç–∞">
            <div id="galleryLoading" class="loading hidden">–ó–∞–≥—Ä—É–∑–∫–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è...</div>
        </div>
        <div class="gallery-controls">
            <button id="prevPhotoBtn" class="gallery-btn">‚óÄ –ù–∞–∑–∞–¥</button>
            <button id="backToModelBtn" class="gallery-btn">–í–µ—Ä–Ω—É—Ç—å—Å—è –∫ 3D</button>
            <button id="nextPhotoBtn" class="gallery-btn">–í–ø–µ—Ä–µ–¥ ‚ñ∂</button>
        </div>
    </div>

    <script src="https://cdn.babylonjs.com/babylon.js"></script>
    <script src="https://cdn.babylonjs.com/loaders/babylonjs.loaders.min.js"></script>
    
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // –≠–ª–µ–º–µ–Ω—Ç—ã –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞
            const fullscreenOverlay = document.getElementById('fullscreenOverlay');
            const enterFullscreenBtn = document.getElementById('enterFullscreen');
            const canvas = document.getElementById('renderCanvas');
            const loadingElement = document.getElementById('loading');
            const clinicTitle = document.getElementById('clinicTitle');
            const viewIndicator = document.getElementById('viewIndicator');
            const modeIndicator = document.getElementById('modeIndicator');
            const gyroStatus = document.getElementById('gyroStatus');
            const sideIndicator = document.getElementById('sideIndicator');
            const gestureIndicator = document.getElementById('gestureIndicator');
            const modeToggleBtn = document.getElementById('modeToggleBtn');
            const galleryToggleBtn = document.getElementById('galleryToggleBtn');
            const musicToggleBtn = document.getElementById('musicToggleBtn');
            const volumeControl = document.getElementById('volumeControl');
            const volumeLevel = document.getElementById('volumeLevel');
            const errorMessage = document.getElementById('errorMessage');
            const vrDivider = document.getElementById('vrDivider');
            const galleryLoading = document.getElementById('galleryLoading');
            
            // –≠–ª–µ–º–µ–Ω—Ç—ã –≥–∞–ª–µ—Ä–µ–∏
            const galleryContainer = document.getElementById('galleryContainer');
            const galleryImage = document.getElementById('galleryImage');
            const prevPhotoBtn = document.getElementById('prevPhotoBtn');
            const nextPhotoBtn = document.getElementById('nextPhotoBtn');
            const backToModelBtn = document.getElementById('backToModelBtn');
            const photoCounter = document.getElementById('photoCounter');
            
            // –î–∞–Ω–Ω—ã–µ –≥–∞–ª–µ—Ä–µ–∏ - –∑–∞–º–µ–Ω–∏—Ç–µ –Ω–∞ —Ä–µ–∞–ª—å–Ω—ã–µ –ø—É—Ç–∏ –∫ –≤–∞—à–∏–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è–º
            const photos = [
                './l1.jpg',
                './l2.jpg',
            ];
            
            let currentPhotoIndex = 0;
            let isInGallery = false;
            
            // –ê—É–¥–∏–æ —ç–ª–µ–º–µ–Ω—Ç—ã
            let backgroundMusic = new Audio();
            let isMusicPlaying = false;
            let volume = 0.7;
            
            // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∞–¥–∞–ø—Ç–∞—Ü–∏–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –ø–æ–¥ —ç–∫—Ä–∞–Ω
            function adaptImageToScreen() {
                if (!isInGallery) return;
                
                const screenWidth = window.innerWidth;
                const screenHeight = window.innerHeight;
                const screenRatio = screenWidth / screenHeight;
                
                // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –æ—Ä–∏–µ–Ω—Ç–∞—Ü–∏—é —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞
                const isPortrait = screenHeight > screenWidth;
                
                // –î–ª—è –ø–æ—Ä—Ç—Ä–µ—Ç–Ω–æ–π –æ—Ä–∏–µ–Ω—Ç–∞—Ü–∏–∏ - contain, –¥–ª—è –ª–∞–Ω–¥—à–∞—Ñ—Ç–Ω–æ–π - cover –∏–ª–∏ contain –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Å–æ–æ—Ç–Ω–æ—à–µ–Ω–∏—è
                if (isPortrait) {
                    galleryImage.style.objectFit = 'contain';
                } else {
                    // –ï—Å–ª–∏ —ç–∫—Ä–∞–Ω –æ—á–µ–Ω—å —à–∏—Ä–æ–∫–∏–π, –∏—Å–ø–æ–ª—å–∑—É–µ–º cover –¥–ª—è –ª—É—á—à–µ–≥–æ –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è
                    if (screenRatio > 1.8) {
                        galleryImage.style.objectFit = 'cover';
                    } else {
                        galleryImage.style.objectFit = 'contain';
                    }
                }
                
                console.log(`–ê–¥–∞–ø—Ç–∞—Ü–∏—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è: ${screenWidth}x${screenHeight}, ratio: ${screenRatio.toFixed(2)}, object-fit: ${galleryImage.style.objectFit}`);
            }
            
            // –°–ª—É—à–∞—Ç–µ–ª—å –∏–∑–º–µ–Ω–µ–Ω–∏—è —Ä–∞–∑–º–µ—Ä–∞ –æ–∫–Ω–∞
            window.addEventListener('resize', adaptImageToScreen);
            window.addEventListener('orientationchange', adaptImageToScreen);
            
            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –º—É–∑—ã–∫–∏
            function initMusic() {
                backgroundMusic.src = './music.mp3';
                backgroundMusic.loop = true;
                backgroundMusic.volume = volume;
                updateVolumeDisplay();
            }
            
            // –§—É–Ω–∫—Ü–∏—è –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è –º—É–∑—ã–∫–∏
            function toggleMusic() {
                if (isMusicPlaying) {
                    backgroundMusic.pause();
                    musicToggleBtn.textContent = 'üîá';
                    musicToggleBtn.classList.add('muted');
                } else {
                    backgroundMusic.play().catch(e => {
                        console.log("–ê–≤—Ç–æ–≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–æ, —Ç—Ä–µ–±—É–µ—Ç—Å—è –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è");
                    });
                    musicToggleBtn.textContent = 'üîä';
                    musicToggleBtn.classList.remove('muted');
                }
                isMusicPlaying = !isMusicPlaying;
            }
            
            // –§—É–Ω–∫—Ü–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏—è –≥—Ä–æ–º–∫–æ—Å—Ç–∏
            function changeVolume(delta) {
                volume = Math.max(0, Math.min(1, volume + delta));
                backgroundMusic.volume = volume;
                updateVolumeDisplay();
            }
            
            // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –≥—Ä–æ–º–∫–æ—Å—Ç–∏
            function updateVolumeDisplay() {
                volumeLevel.style.height = (volume * 100) + '%';
            }
            
            // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –º—É–∑—ã–∫–æ–π
            musicToggleBtn.addEventListener('click', toggleMusic);
            
            // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è —Ä–µ–≥—É–ª—è—Ç–æ—Ä–∞ –≥—Ä–æ–º–∫–æ—Å—Ç–∏
            document.querySelector('.volume-up').addEventListener('click', () => changeVolume(0.1));
            document.querySelector('.volume-down').addEventListener('click', () => changeVolume(-0.1));
            
            // –ü–æ–∫–∞–∑/—Å–∫—Ä—ã—Ç–∏–µ —Ä–µ–≥—É–ª—è—Ç–æ—Ä–∞ –≥—Ä–æ–º–∫–æ—Å—Ç–∏ –ø—Ä–∏ –¥–æ–ª–≥–æ–º –Ω–∞–∂–∞—Ç–∏–∏ –Ω–∞ –∫–Ω–æ–ø–∫—É –º—É–∑—ã–∫–∏
            let musicButtonTimer;
            musicToggleBtn.addEventListener('touchstart', function() {
                musicButtonTimer = setTimeout(() => {
                    volumeControl.classList.toggle('hidden');
                }, 500);
            });
            
            musicToggleBtn.addEventListener('touchend', function() {
                clearTimeout(musicButtonTimer);
            });
            
            musicToggleBtn.addEventListener('click', function(e) {
                if (e.detail === 2) {
                    volumeControl.classList.toggle('hidden');
                }
            });
            
            // –§—É–Ω–∫—Ü–∏–∏ –≥–∞–ª–µ—Ä–µ–∏
            function showGallery() {
                isInGallery = true;
                canvas.classList.add('hidden');
                clinicTitle.classList.add('hidden');
                viewIndicator.classList.add('hidden');
                modeIndicator.classList.add('hidden');
                gyroStatus.classList.add('hidden');
                sideIndicator.classList.add('hidden');
                modeToggleBtn.classList.add('hidden');
                galleryToggleBtn.classList.add('hidden');
                musicToggleBtn.classList.add('hidden');
                volumeControl.classList.add('hidden');
                vrDivider.classList.add('hidden');
                galleryContainer.classList.remove('hidden');
                
                // –ê–¥–∞–ø—Ç–∏—Ä—É–µ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –ø–æ–¥ —Ç–µ–∫—É—â–∏–π —ç–∫—Ä–∞–Ω
                adaptImageToScreen();
                loadPhoto(currentPhotoIndex);
            }
            
            function showModel() {
                isInGallery = false;
                galleryContainer.classList.add('hidden');
                canvas.classList.remove('hidden');
                clinicTitle.classList.remove('hidden');
                viewIndicator.classList.remove('hidden');
                modeIndicator.classList.remove('hidden');
                gyroStatus.classList.remove('hidden');
                sideIndicator.classList.remove('hidden');
                modeToggleBtn.classList.remove('hidden');
                galleryToggleBtn.classList.remove('hidden');
                musicToggleBtn.classList.remove('hidden');
            }
            
            function loadPhoto(index) {
                currentPhotoIndex = index;
                galleryLoading.classList.remove('hidden');
                galleryImage.style.opacity = '0';
                
                const img = new Image();
                img.onload = function() {
                    galleryImage.src = this.src;
                    galleryImage.style.opacity = '1';
                    galleryLoading.classList.add('hidden');
                    photoCounter.textContent = `–§–æ—Ç–æ ${index + 1}/${photos.length}`;
                    
                    // –ü–æ–≤—Ç–æ—Ä–Ω–∞—è –∞–¥–∞–ø—Ç–∞—Ü–∏—è –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
                    setTimeout(adaptImageToScreen, 100);
                };
                
                img.onerror = function() {
                    console.error("–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ:", photos[index]);
                    
                    // –°–æ–∑–¥–∞–µ–º —Ü–≤–µ—Ç–Ω—É—é –∑–∞–≥–ª—É—à–∫—É, –∞–¥–∞–ø—Ç–∏—Ä–æ–≤–∞–Ω–Ω—É—é –ø–æ–¥ —ç–∫—Ä–∞–Ω
                    const colors = ['#ff6b6b', '#4ecdc4', '#45b7d1', '#96ceb4', '#feca57', 
                                   '#ff9ff3', '#54a0ff', '#5f27cd', '#00d2d3', '#ff9f43'];
                    const color = colors[index % colors.length];
                    
                    const screenWidth = window.innerWidth;
                    const screenHeight = window.innerHeight;
                    
                    const tempCanvas = document.createElement('canvas');
                    tempCanvas.width = screenWidth;
                    tempCanvas.height = screenHeight;
                    const ctx = tempCanvas.getContext('2d');
                    
                    ctx.fillStyle = color;
                    ctx.fillRect(0, 0, screenWidth, screenHeight);
                    ctx.fillStyle = 'white';
                    
                    // –ê–¥–∞–ø—Ç–∏—Ä—É–µ–º —Ä–∞–∑–º–µ—Ä —Ç–µ–∫—Å—Ç–∞ –ø–æ–¥ —ç–∫—Ä–∞–Ω
                    const fontSize = Math.min(screenWidth, screenHeight) * 0.05;
                    ctx.font = `bold ${fontSize}px Arial`;
                    ctx.textAlign = 'center';
                    ctx.fillText(`–§–æ—Ç–æ ${index + 1}`, screenWidth/2, screenHeight/2);
                    
                    ctx.font = `${fontSize * 0.5}px Arial`;
                    ctx.fillText('–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ', screenWidth/2, screenHeight/2 + fontSize);
                    
                    galleryImage.src = tempCanvas.toDataURL();
                    galleryImage.style.opacity = '1';
                    galleryLoading.classList.add('hidden');
                    photoCounter.textContent = `–§–æ—Ç–æ ${index + 1}/${photos.length}`;
                };
                
                img.src = photos[index];
            }
            
            function nextPhoto() {
                currentPhotoIndex = (currentPhotoIndex + 1) % photos.length;
                loadPhoto(currentPhotoIndex);
            }
            
            function prevPhoto() {
                currentPhotoIndex = (currentPhotoIndex - 1 + photos.length) % photos.length;
                loadPhoto(currentPhotoIndex);
            }
            
            // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –≥–∞–ª–µ—Ä–µ–∏
            galleryToggleBtn.addEventListener('click', showGallery);
            backToModelBtn.addEventListener('click', showModel);
            nextPhotoBtn.addEventListener('click', nextPhoto);
            prevPhotoBtn.addEventListener('click', prevPhoto);
            
            // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã –≤ –≥–∞–ª–µ—Ä–µ–µ
            document.addEventListener('keydown', function(e) {
                if (!isInGallery) return;
                
                if (e.key === 'ArrowLeft') {
                    prevPhoto();
                } else if (e.key === 'ArrowRight') {
                    nextPhoto();
                } else if (e.key === 'Escape') {
                    showModel();
                }
            });
            
            // –£–ª—É—á—à–µ–Ω–Ω—ã–µ —Å–≤–∞–π–ø—ã –¥–ª—è –≥–∞–ª–µ—Ä–µ–∏
            let galleryStartX = 0;
            let galleryStartY = 0;
            
            galleryContainer.addEventListener('touchstart', function(e) {
                galleryStartX = e.touches[0].clientX;
                galleryStartY = e.touches[0].clientY;
            });
            
            galleryContainer.addEventListener('touchend', function(e) {
                if (!galleryStartX) return;
                
                const endX = e.changedTouches[0].clientX;
                const endY = e.changedTouches[0].clientY;
                const diffX = galleryStartX - endX;
                const diffY = galleryStartY - endY;
                
                if (Math.abs(diffX) > Math.abs(diffY) && Math.abs(diffX) > 50) {
                    if (diffX > 0) {
                        nextPhoto();
                    } else {
                        prevPhoto();
                    }
                }
                
                galleryStartX = 0;
                galleryStartY = 0;
            });
            
            // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –≤—Ö–æ–¥–∞ –≤ –ø–æ–ª–Ω–æ—ç–∫—Ä–∞–Ω–Ω—ã–π —Ä–µ–∂–∏–º
            function enterFullscreen() {
                const element = document.documentElement;
                
                if (element.requestFullscreen) {
                    element.requestFullscreen();
                } else if (element.mozRequestFullScreen) {
                    element.mozRequestFullScreen();
                } else if (element.webkitRequestFullscreen) {
                    element.webkitRequestfullscreen();
                } else if (element.msRequestFullscreen) {
                    element.msRequestFullscreen();
                }
                
                fullscreenOverlay.classList.add('hidden');
                loadingElement.classList.remove('hidden');
                canvas.classList.remove('hidden');
                clinicTitle.classList.remove('hidden');
                viewIndicator.classList.remove('hidden');
                modeIndicator.classList.remove('hidden');
                gyroStatus.classList.remove('hidden');
                sideIndicator.classList.remove('hidden');
                modeToggleBtn.classList.remove('hidden');
                galleryToggleBtn.classList.remove('hidden');
                musicToggleBtn.classList.remove('hidden');
                
                initMusic();
                initApp();
            }
            
            enterFullscreenBtn.addEventListener('click', enterFullscreen);
            fullscreenOverlay.addEventListener('click', enterFullscreen);
            
            document.addEventListener('touchstart', function() {
                if (!document.fullscreenElement && !fullscreenOverlay.classList.contains('hidden')) {
                    enterFullscreen();
                }
            });
            
            // –û—Å–Ω–æ–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
            function initApp() {
                const engine = new BABYLON.Engine(canvas, true, {
                    preserveDrawingBuffer: true,
                    stencil: true
                });
                
                const scene = new BABYLON.Scene(engine);
                scene.clearColor = new BABYLON.Color4(0, 0, 0, 1);
                
                // –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è
                let isVRMode = false;
                let isStereoscopicMode = false;
                let gyroEnabled = false;
                let alphaOffset = 0;
                let betaOffset = 0;
                let needCalibration = false;
                let autoRotate = false;
                let autoRotateSpeed = 0.005;
                
                const modes = [
                    { 
                        name: "–û–±—ã—á–Ω—ã–π", 
                        value: "manual", 
                        icon: "üëÜ",
                        description: "–û–±—ã—á–Ω—ã–π —Ä–µ–∂–∏–º"
                    },
                    { 
                        name: "–ê–≤—Ç–æ–ø–æ–≤–æ—Ä–æ—Ç", 
                        value: "auto", 
                        icon: "üîÑ",
                        description: "–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –≤—Ä–∞—â–µ–Ω–∏–µ"
                    },
                    { 
                        name: "VR –°—Ç–µ—Ä–µ–æ", 
                        value: "vr_stereo", 
                        icon: "üëì",
                        description: "VR —Å—Ç–µ—Ä–µ–æ—Å–∫–æ–ø–∏—á–µ—Å–∫–∏–π —Ä–µ–∂–∏–º"
                    },
                    { 
                        name: "VR", 
                        value: "vr", 
                        icon: "ü•Ω",
                        description: "VR —Ä–µ–∂–∏–º —Å –≥–∏—Ä–æ—Å–∫–æ–ø–æ–º"
                    }
                ];
                
                let currentModeIndex = 0;
                
                const buildingSides = [
                    { name: "–§–∞—Å–∞–¥", alpha: -Math.PI/2, beta: Math.PI/2.5, radius: 25 },
                    { name: "–ü—Ä–∞–≤–∞—è —Å—Ç–æ—Ä–æ–Ω–∞", alpha: 0, beta: Math.PI/2.5, radius: 25 },
                    { name: "–¢—ã–ª—å–Ω–∞—è —Å—Ç–æ—Ä–æ–Ω–∞", alpha: Math.PI/2, beta: Math.PI/2.5, radius: 25 },
                    { name: "–õ–µ–≤–∞—è —Å—Ç–æ—Ä–æ–Ω–∞", alpha: Math.PI, beta: Math.PI/2.5, radius: 25 },
                    { name: "–í–∏–¥ —Å–≤–µ—Ä—Ö—É", alpha: -Math.PI/2, beta: 0.2, radius: 30 },
                    { name: "–í–∏–¥ —Å–Ω–∏–∑—É", alpha: -Math.PI/2, beta: Math.PI - 0.2, radius: 30 }
                ];
                
                let currentSideIndex = 0;
                
                let camera = new BABYLON.ArcRotateCamera(
                    "camera", 
                    buildingSides[currentSideIndex].alpha, 
                    buildingSides[currentSideIndex].beta, 
                    buildingSides[currentSideIndex].radius, 
                    BABYLON.Vector3.Zero(), 
                    scene
                );
                
                let leftCamera, rightCamera;
                
                camera.lowerRadiusLimit = 10;
                camera.upperRadiusLimit = 100;
                camera.lowerBetaLimit = 0.1;
                camera.upperBetaLimit = Math.PI - 0.1;
                camera.panningSensibility = 1000;
                camera.wheelPrecision = 50;
                camera.inertia = 0.9;
                
                camera.inputs.clear();
                
                const light = new BABYLON.HemisphericLight("light", new BABYLON.Vector3(0, 1, 0), scene);
                light.intensity = 1;
                
                const modelPath = "./building.glb";
                
                loadingElement.innerHTML = "–ó–∞–≥—Ä—É–∑–∫–∞ –º–æ–¥–µ–ª–∏...<br><small>–ü—É—Ç—å: " + modelPath + "</small>";
                
                function createTestCube() {
                    console.log("–°–æ–∑–¥–∞–µ–º —Ç–µ—Å—Ç–æ–≤—ã–π –∫—É–± –≤–º–µ—Å—Ç–æ –º–æ–¥–µ–ª–∏");
                    
                    const testCube = BABYLON.MeshBuilder.CreateBox("testCube", { size: 5 }, scene);
                    const material = new BABYLON.StandardMaterial("testMaterial", scene);
                    material.diffuseColor = new BABYLON.Color3(0.5, 0.5, 1);
                    testCube.material = material;
                    testCube.position.y = 2.5;
                    
                    const ground = BABYLON.MeshBuilder.CreateGround("ground", { width: 50, height: 50 }, scene);
                    const groundMaterial = new BABYLON.StandardMaterial("groundMaterial", scene);
                    groundMaterial.diffuseColor = new BABYLON.Color3(0.3, 0.5, 0.2);
                    ground.material = groundMaterial;
                    
                    return testCube;
                }
                
                function hideInterfaceWithDelay() {
                    setTimeout(() => {
                        sideIndicator.classList.add('fade-out');
                        setTimeout(() => {
                            sideIndicator.classList.add('hidden');
                        }, 500);
                    }, 5000);
                    
                    let viewIndicatorTimeout, modeIndicatorTimeout;
                    
                    function resetViewIndicatorTimer() {
                        clearTimeout(viewIndicatorTimeout);
                        viewIndicator.classList.remove('fade-out');
                        viewIndicator.classList.remove('hidden');
                        viewIndicatorTimeout = setTimeout(() => {
                            viewIndicator.classList.add('fade-out');
                            setTimeout(() => {
                                viewIndicator.classList.add('hidden');
                            }, 500);
                        }, 3000);
                    }
                    
                    function resetModeIndicatorTimer() {
                        clearTimeout(modeIndicatorTimeout);
                        modeIndicator.classList.remove('fade-out');
                        modeIndicator.classList.remove('hidden');
                        modeIndicatorTimeout = setTimeout(() => {
                            modeIndicator.classList.add('fade-out');
                            setTimeout(() => {
                                modeIndicator.classList.add('hidden');
                            }, 500);
                        }, 3000);
                    }
                    
                    resetViewIndicatorTimer();
                    resetModeIndicatorTimer();
                    
                    return { resetViewIndicatorTimer, resetModeIndicatorTimer };
                }
                
                function setupStereoscopicVR() {
                    if (leftCamera) {
                        leftCamera.dispose();
                    }
                    if (rightCamera) {
                        rightCamera.dispose();
                    }
                    
                    leftCamera = new BABYLON.ArcRotateCamera(
                        "leftCamera", 
                        camera.alpha, 
                        camera.beta, 
                        camera.radius, 
                        camera.getTarget(), 
                        scene
                    );
                    
                    rightCamera = new BABYLON.ArcRotateCamera(
                        "rightCamera", 
                        camera.alpha, 
                        camera.beta, 
                        camera.radius, 
                        camera.getTarget(), 
                        scene
                    );
                    
                    leftCamera.viewport = new BABYLON.Viewport(0, 0, 0.5, 1.0);
                    rightCamera.viewport = new BABYLON.Viewport(0.5, 0, 0.5, 1.0);
                    
                    leftCamera.inputs.clear();
                    rightCamera.inputs.clear();
                    
                    scene.activeCameras = [leftCamera, rightCamera];
                    
                    vrDivider.classList.remove('hidden');
                    
                    console.log("–°—Ç–µ—Ä–µ–æ—Å–∫–æ–ø–∏—á–µ—Å–∫–∏–π VR —Ä–µ–∂–∏–º –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω");
                }
                
                function disableStereoscopicVR() {
                    scene.activeCameras = [camera];
                    vrDivider.classList.add('hidden');
                    console.log("–°—Ç–µ—Ä–µ–æ—Å–∫–æ–ø–∏—á–µ—Å–∫–∏–π VR —Ä–µ–∂–∏–º –æ—Ç–∫–ª—é—á–µ–Ω");
                }
                
                function switchMode(resetModeIndicatorTimer) {
                    currentModeIndex = (currentModeIndex + 1) % modes.length;
                    const newMode = modes[currentModeIndex];
                    
                    isVRMode = newMode.value === "vr" || newMode.value === "vr_stereo";
                    isStereoscopicMode = newMode.value === "vr_stereo";
                    autoRotate = newMode.value === "auto";
                    
                    if (isStereoscopicMode) {
                        setupStereoscopicVR();
                    } else {
                        disableStereoscopicVR();
                    }
                    
                    modeToggleBtn.textContent = newMode.icon;
                    modeIndicator.textContent = "–†–µ–∂–∏–º: " + newMode.name;
                    sideIndicator.textContent = newMode.description;
                    
                    if (isVRMode) {
                        needCalibration = true;
                        console.log("VR —Ä–µ–∂–∏–º –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω");
                        initGyroscope();
                    } else if (autoRotate) {
                        console.log("–ê–≤—Ç–æ–ø–æ–≤–æ—Ä–æ—Ç –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω");
                    } else {
                        console.log("–û–±—ã—á–Ω—ã–π —Ä–µ–∂–∏–º –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω");
                    }
                    
                    resetModeIndicatorTimer();
                    
                    sideIndicator.classList.remove('fade-out');
                    sideIndicator.classList.remove('hidden');
                    setTimeout(() => {
                        sideIndicator.classList.add('fade-out');
                        setTimeout(() => {
                            sideIndicator.classList.add('hidden');
                        }, 500);
                    }, 3000);
                    
                    gestureIndicator.textContent = newMode.icon;
                    gestureIndicator.classList.add('active');
                    gestureIndicator.classList.add('tap-animation');
                    
                    setTimeout(() => {
                        gestureIndicator.classList.remove('active');
                    }, 2000);
                }
                
                BABYLON.SceneLoader.ImportMesh("", modelPath, "", scene, 
                    function(meshes, particleSystems, skeletons, animationGroups) {
                        console.log("–ú–æ–¥–µ–ª—å —É—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω–∞:", meshes);
                        
                        loadingElement.classList.add('hidden');
                        
                        let building;
                        
                        if (meshes && meshes.length > 0) {
                            building = meshes[0];
                            
                            if (building.getBoundingInfo) {
                                const boundingInfo = building.getBoundingInfo();
                                const center = boundingInfo.boundingBox.center;
                                
                                camera.setTarget(center);
                                
                                const extend = boundingInfo.boundingBox.extendSize;
                                const modelSize = Math.max(extend.x, extend.y, extend.z);
                                const optimalRadius = modelSize * 4;
                                
                                buildingSides.forEach(side => {
                                    if (side.name.includes("—Å–≤–µ—Ä—Ö—É") || side.name.includes("—Å–Ω–∏–∑—É")) {
                                        side.radius = Math.max(30, optimalRadius);
                                    } else {
                                        side.radius = Math.max(25, optimalRadius);
                                    }
                                });
                                
                                camera.radius = buildingSides[currentSideIndex].radius;
                            } else {
                                console.warn("–ú–æ–¥–µ–ª—å –Ω–µ –∏–º–µ–µ—Ç bounding info");
                            }
                        } else {
                            console.warn("–ú–æ–¥–µ–ª—å –∑–∞–≥—Ä—É–∂–µ–Ω–∞, –Ω–æ –Ω–µ —Å–æ–¥–µ—Ä–∂–∏—Ç –º–µ—à–µ–π");
                            building = createTestCube();
                        }
                        
                        const { resetViewIndicatorTimer, resetModeIndicatorTimer } = hideInterfaceWithDelay();
                        initTouchControls(resetViewIndicatorTimer);
                        
                        modeToggleBtn.addEventListener('click', function() {
                            switchMode(resetModeIndicatorTimer);
                        });
                        
                    }, 
                    function(evt) {
                        if (evt.lengthComputable) {
                            const percentLoaded = (evt.loaded / evt.total * 100).toFixed(0);
                            loadingElement.innerHTML = `–ó–∞–≥—Ä—É–∑–∫–∞ –º–æ–¥–µ–ª–∏... ${percentLoaded}%`;
                        }
                    }, 
                    function(scene, message, exception) {
                        console.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –º–æ–¥–µ–ª–∏:", message, exception);
                        
                        createTestCube();
                        
                        errorMessage.innerHTML = "–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –º–æ–¥–µ–ª–∏: " + message + 
                                                "<br>–°–æ–∑–¥–∞–Ω —Ç–µ—Å—Ç–æ–≤—ã–π –∫—É–± –¥–ª—è –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏–∏." +
                                                "<br>–£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ —Ñ–∞–π–ª building.glb –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –≤ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–π –ø–∞–ø–∫–µ.";
                        errorMessage.classList.remove('hidden');
                        
                        loadingElement.classList.add('hidden');
                        
                        const { resetViewIndicatorTimer, resetModeIndicatorTimer } = hideInterfaceWithDelay();
                        initTouchControls(resetViewIndicatorTimer);
                        
                        modeToggleBtn.addEventListener('click', function() {
                            switchMode(resetModeIndicatorTimer);
                        });
                        
                        setTimeout(() => {
                            errorMessage.classList.add('hidden');
                        }, 5000);
                    }
                );
                
                function changeBuildingSide(resetViewIndicatorTimer) {
                    currentSideIndex = (currentSideIndex + 1) % buildingSides.length;
                    const newSide = buildingSides[currentSideIndex];
                    
                    camera.animateTo(
                        {
                            alpha: newSide.alpha,
                            beta: newSide.beta,
                            radius: newSide.radius
                        },
                        1000,
                        BABYLON.EasingFunction.CubicEase
                    );
                    
                    viewIndicator.textContent = "–í–∏–¥: " + newSide.name;
                    resetViewIndicatorTimer();
                    
                    sideIndicator.textContent = "–°—Ç–æ—Ä–æ–Ω–∞ –∏–∑–º–µ–Ω–µ–Ω–∞: " + newSide.name;
                    sideIndicator.classList.remove('fade-out');
                    sideIndicator.classList.remove('hidden');
                    setTimeout(() => {
                        sideIndicator.classList.add('fade-out');
                        setTimeout(() => {
                            sideIndicator.classList.add('hidden');
                        }, 500);
                    }, 3000);
                }
                
                function initTouchControls(resetViewIndicatorTimer) {
                    let lastTapTime = 0;
                    let isDragging = false;
                    let previousX = 0;
                    let previousY = 0;
                    let tapCount = 0;
                    let tapTimeout = null;
                    
                    canvas.addEventListener('touchstart', function(e) {
                        const currentTime = new Date().getTime();
                        const tapLength = currentTime - lastTapTime;
                        
                        if (tapLength > 500) {
                            tapCount = 0;
                        }
                        
                        tapCount++;
                        lastTapTime = currentTime;
                        
                        clearTimeout(tapTimeout);
                        
                        tapTimeout = setTimeout(function() {
                            if (tapCount === 1 && !isVRMode && !autoRotate) {
                                changeBuildingSide(resetViewIndicatorTimer);
                            }
                            tapCount = 0;
                        }, 500);
                        
                        if (!isVRMode && !autoRotate) {
                            isDragging = true;
                            previousX = e.touches[0].clientX;
                            previousY = e.touches[0].clientY;
                            
                            gestureIndicator.textContent = 'üëÜ';
                            gestureIndicator.classList.add('active');
                        }
                        
                        e.preventDefault();
                    });
                    
                    canvas.addEventListener('touchmove', function(e) {
                        if (!isDragging || isVRMode || autoRotate) return;
                        
                        const currentX = e.touches[0].clientX;
                        const currentY = e.touches[0].clientY;
                        
                        const deltaX = currentX - previousX;
                        const deltaY = currentY - previousY;
                        
                        camera.alpha -= deltaX * 0.005;
                        camera.beta -= deltaY * 0.005;
                        
                        camera.beta = Math.max(camera.lowerBetaLimit, 
                                              Math.min(camera.upperBetaLimit, camera.beta));
                        
                        previousX = currentX;
                        previousY = currentY;
                        
                        e.preventDefault();
                    });
                    
                    canvas.addEventListener('touchend', function(e) {
                        isDragging = false;
                        
                        setTimeout(() => {
                            gestureIndicator.classList.remove('active');
                        }, 500);
                        
                        e.preventDefault();
                    });
                    
                    let initialDistance = null;
                    
                    canvas.addEventListener('touchstart', function(e) {
                        if (e.touches.length >= 2 && !isVRMode && !autoRotate) {
                            const dx = e.touches[0].clientX - e.touches[1].clientX;
                            const dy = e.touches[0].clientY - e.touches[1].clientY;
                            initialDistance = Math.sqrt(dx * dx + dy * dy);
                            
                            gestureIndicator.textContent = 'ü§è';
                        }
                    });
                    
                    canvas.addEventListener('touchmove', function(e) {
                        if (e.touches.length >= 2 && initialDistance !== null && !isVRMode && !autoRotate) {
                            const dx = e.touches[0].clientX - e.touches[1].clientX;
                            const dy = e.touches[0].clientY - e.touches[1].clientY;
                            const currentDistance = Math.sqrt(dx * dx + dy * dy);
                            
                            const scale = currentDistance / initialDistance;
                            
                            if (scale > 1) {
                                camera.radius = Math.min(camera.upperRadiusLimit, camera.radius + scale * 0.5);
                            } else {
                                camera.radius = Math.max(camera.lowerRadiusLimit, camera.radius - (2 - scale) * 0.5);
                            }
                            
                            e.preventDefault();
                        }
                    });
                    
                    canvas.addEventListener('touchend', function(e) {
                        if (e.touches.length < 2) {
                            initialDistance = null;
                            gestureIndicator.textContent = 'üëÜ';
                        }
                    });
                    
                    canvas.addEventListener('click', function(e) {
                        if (!isVRMode && !autoRotate) {
                            changeBuildingSide(resetViewIndicatorTimer);
                        }
                        e.preventDefault();
                    });
                }
                
                function initGyroscope() {
                    if (typeof DeviceOrientationEvent !== 'undefined' && 
                        typeof DeviceOrientationEvent.requestPermission === 'function') {
                        DeviceOrientationEvent.requestPermission()
                            .then(response => {
                                if (response === 'granted') {
                                    setupGyroscope();
                                } else {
                                    console.warn('–î–æ—Å—Ç—É–ø –∫ –≥–∏—Ä–æ—Å–∫–æ–ø—É –æ—Ç–∫–ª–æ–Ω–µ–Ω');
                                    gyroStatus.textContent = "–ì–∏—Ä–æ—Å–∫–æ–ø: –î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â–µ–Ω";
                                }
                            })
                            .catch(console.error);
                    } else {
                        setupGyroscope();
                    }
                }
                
                function setupGyroscope() {
                    let lastGamma = 0;
                    let lastBeta = 0;
                    
                    window.addEventListener('deviceorientation', function(event) {
                        if (!gyroEnabled) {
                            gyroEnabled = true;
                            gyroStatus.textContent = "–ì–∏—Ä–æ—Å–∫–æ–ø: –ê–∫—Ç–∏–≤–µ–Ω";
                            loadingElement.classList.add('hidden');
                        }
                        
                        lastGamma = event.gamma;
                        lastBeta = event.beta;
                        
                        if (isVRMode && event.gamma !== null && event.beta !== null) {
                            if (needCalibration) {
                                alphaOffset = camera.alpha - (-lastGamma * (Math.PI / 180));
                                betaOffset = camera.beta - ((lastBeta - 90) * (Math.PI / 180));
                                needCalibration = false;
                                console.log("–ì–∏—Ä–æ—Å–∫–æ–ø –æ—Ç–∫–∞–ª–∏–±—Ä–æ–≤–∞–Ω");
                            }
                            
                            const newAlpha = -lastGamma * (Math.PI / 180) + alphaOffset;
                            const newBeta = (lastBeta - 90) * (Math.PI / 180) + betaOffset;
                            
                            camera.alpha = newAlpha;
                            camera.beta = Math.max(
                                camera.lowerBetaLimit, 
                                Math.min(camera.upperBetaLimit, newBeta)
                            );
                        }
                    });
                    
                    window.addEventListener('devicemotion', function(event) {
                        if (event.rotationRate) {
                            gyroStatus.textContent = "";
                        }
                    });
                }
                
                window.addEventListener('resize', function() {
                    engine.resize();
                });
                
                scene.registerBeforeRender(function() {
                    if (autoRotate && !isVRMode) {
                        camera.alpha += autoRotateSpeed;
                    }
                    
                    if (isStereoscopicMode && leftCamera && rightCamera) {
                        leftCamera.alpha = camera.alpha;
                        leftCamera.beta = camera.beta;
                        leftCamera.radius = camera.radius;
                        leftCamera.setTarget(camera.getTarget());
                        
                        rightCamera.alpha = camera.alpha;
                        rightCamera.beta = camera.beta;
                        rightCamera.radius = camera.radius;
                        rightCamera.setTarget(camera.getTarget());
                        
                        const interpupillaryDistance = 0.5;
                        
                        const rightVector = new BABYLON.Vector3(
                            Math.cos(camera.alpha), 
                            0, 
                            Math.sin(camera.alpha)
                        );
                        
                        leftCamera.position = camera.position.add(rightVector.scale(-interpupillaryDistance / 2));
                        rightCamera.position = camera.position.add(rightVector.scale(interpupillaryDistance / 2));
                    }
                });
                
                engine.runRenderLoop(function() {
                    scene.render();
                });
                
                document.addEventListener('fullscreenchange', function() {
                    if (!document.fullscreenElement) {
                        if (isVRMode) {
                            isVRMode = false;
                            isStereoscopicMode = false;
                            currentModeIndex = 0;
                            modeToggleBtn.textContent = modes[currentModeIndex].icon;
                            modeIndicator.textContent = "–†–µ–∂–∏–º: " + modes[currentModeIndex].name;
                            disableStereoscopicVR();
                        }
                    }
                });
                
                document.addEventListener('gesturestart', function(e) {
                    e.preventDefault();
                });
                
                document.addEventListener('gesturechange', function(e) {
                    e.preventDefault();
                });
                
                document.addEventListener('gestureend', function(e) {
                    e.preventDefault();
                });
            }
        });
    </script>
</body>
</html>